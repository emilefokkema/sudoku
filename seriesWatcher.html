<html>
<body>
<script src="makeNode.js"></script>
<script src="structureHelpers.js"></script>
<script src="contourMaker.js"></script>
<script src="contourBackgrounds.js"></script>
<script type="makeNode">
(function(){
	var episode = function(title, selectEpisode){
		return <div id="1" style="cursor:pointer"><input type="checkbox" id="3"/><span id="2"></span>function(div, text, checkbox){
			var toReturn;
			text.innerHTML = title;
			var selected = false;
			var select = function(){
				checkbox.checked = selected = true;
			};
			var unselect = function(){
				checkbox.checked = selected = false;
			};
			div.addEventListener('click',function(){selectEpisode(toReturn);});
			toReturn = {
				node: div,
				select:select,
				unselect:unselect
			};
			return toReturn;
		}</div>;
	};
	var series = function(remove){
		return <div id="1" style="width:200px;display:inline;margin:10px"><div id="2" style="padding:5px" data-contour="parent series"></div>
				function(outer, inner){
					remove = (function(old){
						return function(){
							outer.removeChild(inner);
							var width = parseInt(outer.style.width.match(/\d+/)[0]);
							var decreaseWidth = function(){
								if(width > 10){
									width -= 10;
									outer.style.width = width + "px";
									setTimeout(decreaseWidth, 10);
								}else{
									old();
								}
							};
							decreaseWidth();
						};
					})(remove);
					var title = <div id="1" style="position:relative">
									<div style="padding:5px;display:inline-flex">
										<div id="5" data-contour="child title">
										<input type="text" style="width:140px" id="2"/>
										<span id="3" style="display:none"></span>
										</div>
										<input type="button" id="4" value="x" style="background-color:transparent;border:none;margin-left:17px" data-contour="child delete"/>
									</div>
									
									
									function(outer, input, text, removeButton, titleDiv){
										input.addEventListener('blur',function(){
											text.innerHTML = input.value;
											titleDiv.style.width = input.offsetWidth+"px";
											input.style.display = "none";
											text.style.display = "initial";
										});
										removeButton.onclick = remove;
									}
								</div>;
					inner.appendChild(title);
					var episodeList = <div id="1" data-contour="parent list" style="padding:7px">
										<div><input type="button" style="background-color:transparent;border:none" data-contour="child minus" value="-" id="4"/></div>
										<div id="2" style="padding:5px" data-contour="child innerList"></div>
										<div><input type="button" style="background-color:transparent;border:none" data-contour="child plus" value="+" id="3"/></div>
										function(outer, list, addButton, subtractButton){
											var counter, episodeList;
											var selectEpisode = function(e){
												var index = episodeList.indexOf(e);
												episodeList.map(function(ep, i){
													ep[i<=index?"select":"unselect"]();
												});
											};
											episodeList = Array.apply(null, new Array(12)).map(function(x,i){
												return episode("Episode "+(counter = i+1), selectEpisode);
											});

											episodeList.map(function(e){list.appendChild(e.node);});
											var addOne = function(){
												var newOne = episode("Episode "+(++counter), selectEpisode);
												episodeList.push(newOne);
												list.appendChild(newOne.node);
											};
											var removeOne = function(){
												if(episodeList.length > 0){
													list.removeChild(episodeList[0].node);
													episodeList.splice(0,1);
												}
											};
											addButton.onclick = addOne;
											subtractButton.onclick = removeOne;
										}
										</div>;
					inner.appendChild(episodeList);
				}
				</div>;
	};
	var container = <div style="display:inline-flex" id="1">
						<div id="2" style="display:inline-flex"></div>
						<div><input type="button" value="+" id="3"/></div>
						function(outer, list, addButton){
							var seriesList = [];
							var remove = function(which){
								list.removeChild(which);
								seriesList.splice(seriesList.indexOf(which),1);
							};
							var addOne = function(){
								var newOne;
								newOne = series(function(){remove(newOne);});
								seriesList.push(newOne);
								list.appendChild(newOne);
							};
							
							addButton.onclick = addOne;
							addOne();
							document.body.appendChild(outer);
						}
					</div>;
	contourBackgrounds({
		"list": function(parent, children){
			var plusMinus = children.plus.box().plus(children.minus.box()).toRectangle();
			return [
				{
					color: '#000',
					fill: '#eee',
					contour: children.innerList.combine(plusMinus.expand(3)),
					borderRadius:6,
					width:0.5
				}
			];
		},
		"series": function(parent, children){
			return [
				{
					color: '#000',
					fill: '#ddd',
					contour: parent.expand(-2).box().expand({bottom:-15}).toRectangle().combineNegative(children.title.expand(11).box().expand({bottom:5}).toRectangle()),
					borderRadius:6,
					width:0.5
				}
			];
		}
	});
})();
</script>
</body>

</html>