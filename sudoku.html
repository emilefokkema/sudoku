<html>
<head>
<title>Sudoku</title>
</head>
<body></body>
<script language="JavaScript">
(function(b){
	var sudoku=(function(){
		var rijPositie=function(index,j){return [index, j];};
		var kolomPositie=function(index, j){return [j, index];};
		var vakPositie=(function(){
				var pos=function(i){return [Math.floor(i/3),i%3];};
				return function(index,j){
					var vakPos=pos(index);
					var jPos=pos(j);
					return [
						3*vakPos[0]+jPos[0],
						3*vakPos[1]+jPos[1]
					];
				};
			})();
		var vak2Positie=function(index, j){
			var vakPos=[1+4*(Math.floor(index/2)),1+4*(index%2)];
			var jPos=[Math.floor(j/3),j%3];
			return [
				vakPos[0]+jPos[0],
				vakPos[1]+jPos[1]
			];
		};
		var leeg=function(){
			var g=[];
			for(var i=0;i<9;i++){g.push([0,0,0,0,0,0,0,0,0]);}
			return g;
		};
		var Permutatielijst=function(n){
			var nullen=function(){
				var l=[];
				for(var i=0;i<n;i++){l.push(0);}
				return l;
			};
			var klaar=false;
			var tak=(function(){
				var huidig=nullen();
				var gaVerder=function(){
					var p=n-1;
					while(p>=0){
						if(huidig[p]<n-1-p){
							huidig[p]++;
							return true;
						}else{
							huidig[p]=0;
							p--;
						}
					}
					return false;
				};
				var permutatie=function(){
					var p=nullen();
					var i, j, k, index;
					for(i=0;i<n;i++){
						k=-1;
						index=huidig[i];
						for(j=0;j<n;j++){
							if(p[j]==0){k++;}
							if(k==index){
								p[j]=i+1;
								break;
							}
						}
					}
					return p;
				};
				return {huidig:function(){return huidig;},gaVerder:gaVerder,permutatie:permutatie};

			})();
			var eerste=true;
			var volgende=function(){
				if(eerste){
					eerste=false;
					return tak.permutatie();
				}else{
					if(tak.gaVerder()){
						return tak.permutatie();
					}else{
						klaar=true;
						return null;
					}
				}
			};
			return {volgende:volgende,isKlaar:function(){return klaar;}};
		};
		var versie=function(getallen, andereToestand){
			var gi,g=[];
			
			for(var i=0;i<9;i++){
				gi=[];
				for(var j=0;j<9;j++){
					gi.push(getallen[i][j]);
				}
				g.push(gi);
			}
			var zet=function(rij, kolom, n){
				g[rij][kolom]=n;
			};
			var checkVerzameling=function(positie){
				return function(index, callbackFalse){
					var pos,hier,gehad=[0,0,0,0,0,0,0,0,0];
					for(var j=0;j<9;j++){
						pos=positie(index,j);
						hier=g[pos[0]][pos[1]];
						if(hier>0){
							if(gehad[hier-1]>0){if(callbackFalse){callbackFalse();}return false;}else{
								gehad[hier-1]++;
							}
						}
					}
					return true;
				};
			};
			var verzamelingenMetGetal=function(positie, aantalVerzamelingen){
				return function(n){
					var pos, v=[];
					for(var i=0;i<aantalVerzamelingen;i++){
						for(var j=0;j<9;j++){
							pos=positie(i,j);
							if(g[pos[0]][pos[1]]==n){
								v.push(i);
								break;
							}
						}
					}
					return v;
				};
			};
			var checkRij=checkVerzameling(rijPositie);
			var checkKolom=checkVerzameling(kolomPositie);
			var checkVak=checkVerzameling(vakPositie);
			var checkVak2=checkVerzameling(vak2Positie);
			var checkKolommen=function(){
				for(var i=0;i<9;i++){if(!checkKolom(i)){return false;}}
				return true;
			};
			var checkVakken=function(rijIndex){
				var vakRij=Math.floor(rijIndex/3);
				for(var i=0;i<3;i++){
					if(!checkVak(3*vakRij+i)){return false;}
				}
				return true;
			};
			var checkVakken2=function(rijIndex){
				if(rijIndex%4==0){return true;}else{
					if(rijIndex<4){return checkVak2(0)&&checkVak2(1);}else{return checkVak2(2)&&checkVak2(3);}
				}
			};
			var check=(function(t){
				if(t){
					return function(vanuitRij){
						return checkKolommen()&&checkVakken(vanuitRij)&&checkVakken2(vanuitRij);
					};
				}else{
					return function(vanuitRij){
						return checkKolommen()&&checkVakken(vanuitRij);
					};
				}
			})(andereToestand);
			var checkAlles=function(){
				return check(1)&&check(4)&&check(7);
			};
			var rijenMetGetal=verzamelingenMetGetal(rijPositie, 9);
			var kolommenMetGetal=verzamelingenMetGetal(kolomPositie, 9);
			var vakkenMetGetal=verzamelingenMetGetal(vakPositie, 9);
			var vakken2MetGetal=verzamelingenMetGetal(vak2Positie, 4);
			return {
				getallen:function(){return g;},
				zet:function(rij, kolom, n){zet(rij, kolom, n);return this;},
				checkRij:checkRij,
				checkKolom:checkKolom,
				checkVak:checkVak,
				checkVak2:checkVak2,
				checkKolommen: checkKolommen,
				checkVakken:checkVakken,
				rijenMetGetal:rijenMetGetal,
				kolommenMetGetal:kolommenMetGetal,
				vakkenMetGetal:vakkenMetGetal,
				vakken2MetGetal:vakken2MetGetal,
				check:check,
				checkAlles:checkAlles
			};
		};
		var gegeven=versie(leeg());

		var vulIn=function(v, callback){
			var getallenOver=(function(getallen){
				var o=[];
				var allemaal=function(){return [1,2,3,4,5,6,7,8,9];};
				for(var i=0;i<9;i++){
					var oi=allemaal();
					var g=getallen[i];
					var index;
					for(var j=0;j<9;j++){
						if(g[j]!=0){
							index=oi.indexOf(g[j]);
							oi.splice(index,1);
						}
					}
					o.push(oi);
				}
				return o;
			})(v.getallen()); 

			var permutatoren=(function(over){
				var p=[];
				var vernieuw=[];
				for(var i=0;i<9;i++){
					vernieuw.push((function(index, size){
						return function(){
							p[index]=Permutatielijst(size);
						};
					})(i,over[i].length));
				}
				for(var i=0;i<9;i++){
					vernieuw[i]();
				}
				var zijnKlaar=function(){
					for(var i=0;i<9;i++){
						if(!p[i].isKlaar()){return false;}
					}
					return true;
				};
				return {vernieuw:vernieuw,item:function(i){return p[i];},zijnKlaar:zijnKlaar}
			})(getallenOver);

			var vulRij=(function(over, getallen){
				var vul=[];
				for(var i=0;i<9;i++){
					vul.push((function(index, over, getallen){
						var plekken=[];
						for(var i=0;i<9;i++){
							if(getallen[i]==0){plekken.push(i);}
						}
						return function(permutatie){
							for(var i=0;i<over.length;i++){
								v.zet(index, plekken[permutatie[i]-1], over[i]);
							}
						};

					})(i, over[i], getallen[i]));
				}
				return vul;
			})(getallenOver, v.getallen());

			var maakRijLeeg=(function(getallen){
				var maak=[];
				for(var i=0;i<9;i++){
					maak.push((function(index, getallen){
						var plekken=[];
						for(var i=0;i<9;i++){
							if(getallen[i]==0){plekken.push(i);}
						}
						return function(){
							for(var i=0;i<plekken.length;i++){
								v.zet(index, plekken[i], 0);
							}
						};
					})(i, getallen[i]));
				}
				return maak;
			})(v.getallen());


			var huidigeRij=0;
			var teller=0;
			var p;
			var doorgaan=function(){return huidigeRij<9&&(!permutatoren.zijnKlaar());};

			var go=function(){
				teller=0;
				while(teller<200000&&doorgaan()){
					if(p=permutatoren.item(huidigeRij).volgende()){
						vulRij[huidigeRij](p);
						if(v.check(huidigeRij)){
							huidigeRij++;
						}
					}else{
						maakRijLeeg[huidigeRij]();
						permutatoren.vernieuw[huidigeRij]();
						huidigeRij--;
					}
					teller++;
				}
				if(callback){callback(v.getallen());}
				if(doorgaan()){setTimeout(go, 2);}
			};
			go();
		};

		return {
			zet: gegeven.zet,
			getallen:gegeven.getallen,
			versie: versie,
			vulIn: function(callback, andereToestand){vulIn(versie(gegeven.getallen(), andereToestand), callback);},
			leeg:leeg,
			rijPositie:rijPositie,
			kolomPositie:kolomPositie,
			vakPositie:vakPositie,
			vak2Positie:vak2Positie
		};
	})();
	var editor=(function(){
		var editor=document.createElement('div');
		var form=(function(){
			var node=document.createElement('div');
			node.setAttribute('style', 'width:450px;height:450px');
			var makeRedRow,makeRed=[];
			var makeNotRedRow, makeNotRed=[];
			var setValueRow, setValue=[];
			var toggleInitialColorRow, toggleInitialColor=[];
			var otherState=false;
			var table=document.createElement('table');
			table.setAttribute('style','width:100%;height:100%;margin:0px;padding:0px;border-spacing:0px;color:inherit');
			for(var i=0;i<9;i++){
				makeRedRow=[];
				makeNotRedRow=[];
				setValueRow=[];
				toggleInitialColorRow=[];
				table.appendChild((function(row){
					var tr=document.createElement('tr');
					tr.setAttribute('style','margin:0px;padding:0px;border-spacing:0px');
					for(var i=0;i<9;i++){
						tr.appendChild((function(index){
							var td=document.createElement('td');
							td.setAttribute('style','margin:0px;padding:0px;border-spacing:0px');
							td.appendChild((function(){
								var div=document.createElement('div');
								var vakIndex=(function(){
									var vakrij=Math.floor(row/3);
									var vakkolom=Math.floor(index/3);
									return 3*vakrij+vakkolom;
								})();
								var vak2Index=(function(){
									if(row%4!=0&&index%4!=0){
										var switcher=function(t){if(t<4){return 0;}else{return 1;}};
										return 2*switcher(row)+switcher(index);
									}else{
										return -1;
									}
								})();
								var initialColor="#FFFFFF";
								var border=function(side, thickness){
									var s;
									switch(side){
										case 0:s="border-top";break;
										case 1:s="border-right";break;
										case 2:s="border-bottom";break;
										case 3:s="border-left";break;
									}
									return s+":"+thickness+"pt solid #000;";
								};
								div.setAttribute('style','width:100%;height:100%;'+border(0,row==0?3:1)+border(1,index==8?3:1)+border(3,(index==0||index%3==0)?3:1)+border(2,(row==8||row%3==2)?3:1)+'background-color:'+initialColor);
								div.setAttribute('align', 'center');
								var input=document.createElement('input');
								input.setAttribute('type', 'text');
								input.setAttribute('maxlength', 1);
								input.setAttribute('style', 'border:0px;width:50%;font-size:20px;position:relative;top:50%;transform:translateY(-50%);-webkit-transform:translateY(-50%);background-color:'+initialColor);
								var makeRed_=function(color){
									div.style.backgroundColor=color?color:"#FF0000";
									input.style.backgroundColor=color?color:"#FF0000"
								};
								var makeNotRed_=function(){
									div.style.backgroundColor=initialColor;
									input.style.backgroundColor=initialColor;
								};
								var toggleInitialColor_=(function(ind){
									var on=false;
									return function(){
										if(on){
											initialColor="#FFFFFF";
											makeNotRed_();
											on=false;
										}else{
											initialColor=ind==-1?"#FFFFFF":"#BBBBBB";
											makeRed_(initialColor);
											on=true;
										}
									};
								})(vak2Index);
								var setValue_=function(v){input.value=v;};
								makeRedRow.push(makeRed_);
								makeNotRedRow.push(makeNotRed_);
								setValueRow.push(setValue_);
								toggleInitialColorRow.push(toggleInitialColor_);
								var ignore=false;
								input.onfocus=function(){
									var v=input.value;
									if(v){
										var highlight=function(arr, f){
											for(var i=0;i<arr.length;i++){
												f(arr[i], "#BB5555");
											}
										};
										var versie=sudoku.versie(sudoku.getallen());
										highlight(versie.rijenMetGetal(parseInt(v)), form.makeRedRow);
										highlight(versie.kolommenMetGetal(parseInt(v)), form.makeRedColumn);
										highlight(versie.vakkenMetGetal(parseInt(v)), form.makeRedSquare);
										if(otherState){highlight(versie.vakken2MetGetal(parseInt(v)), form.makeRedSquare2);}
									}
								};
								input.onkeyup=function(){
									var v=input.value;
									if(v!=""&&v.match(/[1-9]/g)==null){
										makeRed_();
										ignore=true;
									}else{
										form.makeNotRed();
										if(v!=""){
											var n=parseInt(v);
											var versie=sudoku.versie(sudoku.getallen()).zet(row, index, n);
											var check=versie.checkKolom(index, function(){ignore=true;form.makeRedColumn(index);})&&versie.checkRij(row, function(){ignore=true;form.makeRedRow(row);})&&versie.checkVak(vakIndex, function(){ignore=true;form.makeRedSquare(vakIndex);})&&((otherState&&vak2Index!=-1)?versie.checkVak2(vak2Index, function(){ignore=true;form.makeRedSquare2(vak2Index);}):true);
											if(check){
												sudoku.zet(row, index, n);
												ignore=false;
											}
										}else{
											sudoku.zet(row, index, 0);
										}
									}
								};
								input.onblur=function(){
									if(ignore){
										setValue_("");
									}
									form.makeNotRed();
								}
								div.appendChild(input);
								return div;
							})());
							return td;
						})(i));
					}
					return tr;
				})(i));
				makeRed.push(makeRedRow);
				makeNotRed.push(makeNotRedRow);
				setValue.push(setValueRow);
				toggleInitialColor.push(toggleInitialColorRow);
			}
			node.appendChild(table);
			editor.appendChild(node);
			var makeRedSet=function(posF){
				var position=function(index){return function(j){return posF(index, j);};};
				return function(i, color){
					var p, pos=position(i);
					for(var j=0;j<9;j++){
						p=pos(j);
						makeRed[p[0]][p[1]](color);
					}
				};
			};

			return {
				makeRedRow: makeRedSet(sudoku.rijPositie),
				makeRedColumn: makeRedSet(sudoku.kolomPositie),
				makeRedSquare: makeRedSet(sudoku.vakPositie),
				makeRedSquare2: makeRedSet(sudoku.vak2Positie),
				makeNotRed: function(){
					for(var i=0;i<9;i++){
						for(var j=0;j<9;j++){
							makeNotRed[i][j]();
						}
					}
				},
				toggleKind: function(){
					otherState=!otherState;
					for(var i=0;i<9;i++){
						for(var j=0;j<9;j++){
							toggleInitialColor[i][j]();
						}
					}
				},
				setAll: function(numbers){
					var n;
					for(var i=0;i<9;i++){
						for(var j=0;j<9;j++){
							n=numbers[i][j]||0;
							setValue[i][j](n==0?'':n);
							sudoku.zet(i, j, n);
						}
					}
				},
				otherState:function(){return otherState}
			};
		})();
		form.setAll([
			[1,0,0,4,0,0,7,0,0],
			[0,0,0,0,0,0,0,2,3],
			[0,0,0,0,2,0,4,0,6],
			[0,0,0,0,9,0,0,0,1],
			[0,1,0,8,0,5,0,9,0],
			[0,0,0,0,0,0,5,7,0],
			[0,0,0,6,0,0,0,0,0],
			[0,7,0,0,0,2,0,0,0],
			[8,0,0,0,3,0,0,4,0]
			]
		);
		var button=function(text, action){
			var node=document.createElement('div');
			node.setAttribute('style','-webkit-appearance:button;width:100px;height:40px;cursor:pointer;margin:5px;font-family:Verdana');
			node.setAttribute('align','center');
			node.appendChild((function(){
				var div=document.createElement('div');
				div.setAttribute('style','position:relative;top:50%;transform:translateY(-50%)');
				div.appendChild(document.createTextNode(text));
				return div;
			})());
			node.onclick=action;
			return node;
		};
		editor.appendChild(button('GO',function(){sudoku.vulIn(function(d){form.setAll(d);}, form.otherState());}));
		editor.appendChild(button('Clear',function(){form.setAll(sudoku.leeg());}));
		editor.appendChild((function(){
			var node=document.createElement('input');
			node.setAttribute('type', 'checkbox');
			node.onclick=function(){
				if(node.checked){
					var check=sudoku.versie(sudoku.getallen(), true).checkAlles();
					if(check){
						form.toggleKind();
					}else{
						node.checked=false;
					}
				}else{
					form.toggleKind();
				}
			};
			return node;
		})());
		b.appendChild(editor);
		return {setAll:form.setAll}
	})();
	window.sudoku=sudoku;
	window.editor=editor;
})(document.body);
</script>
</html>
