<!DOCTYPE html>
<html>
<head><LINK href="maze.css" rel="stylesheet" type="text/css"></head>
<body></body>
<script src="mazeMaker.js"></script>
<script src="../makeModule.js"></script>
<script src="../makeNode.js"></script>
<script src="../structureHelpers.js"></script>
<script src="levelProvider.js"></script>
<script src="svgMazeDrawer.js"></script>
<script src="thingWalker.js"></script>
<script src="positionableThing.js"></script>
<script src="easer.js"></script>
<script src="../contourMaker.js"></script>
<script src="canvasMazeDrawer.js"></script>
<script src="mazeStringifier.js"></script>
<script>
(function(w, h, body, mazeGame){
	Array.prototype.first = function(test){
		var res, found = false;
		for(var i=0;i<this.length;i++){
			if(test(res = this[i])){
				found = true;
				break;
			}
		}
		if(found){
			return res;
		}
		return null;
	};
	var position = function(x,y){
		return {
			x:x,
			y:y,
			minus:function(p){
				return position(x - p.x, y - p.y);
			},
			plus:function(p){
				return position(x + p.x, y + p.y);
			},
			scale:function(r){
				return position(r*x, r*y);
			}
		};
	};
	var mazeMaker = window.getMazeMaker(structureHelpers.timeoutWhile);
	var chooseRandom = function(arr){
		return arr[Math.floor(Math.random() * arr.length)];
	};

	var space = (function(){
		var shift = position(0,0);
		var boxSize, maxY, maxX;
		var setBoxSize = function(s){
			boxSize = s;
			maxY = Math.floor(h / boxSize);
			maxX = Math.floor(w / boxSize);
		};
		var mazePositionToScreenPosition = function(p){
			return position(boxSize * (p.x + 1/2), boxSize * (p.y + 1/2)).plus(shift);
		};

		var representsSmallDistance = function(dx, dy){
			return Math.abs(dx) + Math.abs(dy) < boxSize / 3;
		};
		return {
			positionFromMazePosition:mazePositionToScreenPosition,
			representsSmallDistance:representsSmallDistance,
			getMaxX:function(){return maxX;},
			getMaxY:function(){return maxY;},
			setBoxSize:setBoxSize,
			getBoxSize:function(){return boxSize;},
			setShift:function(s){shift = s;}
		};

	})();
	var positionableThing = mazeGame.getPositionableThing(space, structureHelpers.copySet);
	var direction = mazeMaker.direction;
	var svgMazeDrawer = mazeGame.getSvgMazeDrawer(direction, structureHelpers.timeoutWhile, contourMaker, position, space.setShift);
	var easer = mazeGame.getEaser(makeModule, position, space.representsSmallDistance);
	var thingWalker = mazeGame.getThingWalker(makeModule, easer, direction, space.positionFromMazePosition, body, chooseRandom);
	var mazeStringifier = mazeGame.getMazeStringifier(direction);
	var mazeDrawer = mazeGame.getCanvasMazeDrawer(direction);
	var levelProvider = mazeGame.getLevelProvider();
	


	var progressMaker = function(setup, done){
		done = done || function(){};
		setup = setup();
		var stopped = false;
		return {
			update:function(x){
				if(!stopped){
					setup.update(x);
				}
			},
			done:function(){setup.teardown();stopped = true;done();}
		};
	};

	var progressBar = function(){
		var started = false, currentPercentage = 0, done = false;
		var bar = makeNode("<div id='1' class='progress-container'><div class='progress-text' id='3'></div><div class='progress-total'><div id='2' class='progress-part'></div></div></div>",function(tot,part,text){
			return {
				append:function(){
					body.appendChild(tot);
				},
				remove:function(){
					body.removeChild(tot);
				},
				setPercentage:function(x){
					part.style.width = Math.floor(100 * x) + "%";
				},
				setText:function(t){
					text.innerHTML = t;
				}
			};
		});
		var updateGlobal = function(x){
			if(!started){
				bar.append();
			}
			started = true;
			currentPercentage = x;
			bar.setPercentage(x);
		};
		var createProgressPart = function(text){
			var textSet = false;
			return progressMaker(function(){
				return {
					update:function(x){
						if(!textSet){
							bar.setText(text);
							textSet = true;
						}
						updateGlobal(x.total);
					},
					teardown:function(){
						if(!done && currentPercentage > 0.99){
							bar.remove();
							done = true;
						}
					}
				};
			});
		};
		return {createProgressPart:createProgressPart};
	};

	var showPopup = function(html, confirm, reject){
		var div;
		disappear = function(){
			body.removeChild(div.node);
		};
		div = makeNode("<div id='2' class='popup popup-container' style='top:"+(2*h)+"px'><div>"+html+"</div><div id='1'></div></div>",function(buttonDiv, container){
			var ok, cancel;
			if(confirm){
				ok = makeNode("<input type='button' class='popup popup-button right' value='OK'/>");
				buttonDiv.appendChild(ok);
				ok.onclick = function(){
					disappear();
					confirm();
				};
			}
			if(reject){
				cancel = makeNode("<input type='button' class='popup popup-button left' value='Cancel'/>");
				buttonDiv.appendChild(cancel);
				cancel.onclick = function(){
					disappear();
					reject();
				};
			}
			return {
				node:container,
				focus:function(){
					ok.focus();
				},
				setTop:function(p){
					container.style.top = p;
				}
			};
		});
		body.appendChild(div.node);
		div.focus();
		setTimeout(function(){
			div.setTop((h/4)+"px");
		},1);
		
	};

	var playLevelWithModel = function(svg, l, model, onSucceed, onFail){
		var succeed, fail, succeeded = false, failed = false;
		var circleThing = function(color, onMeeting){
			var circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
			circle.setAttribute('r',space.getBoxSize() * 0.25);
			circle.setAttribute('fill',color);
			var setPosition = function(p){
				circle.setAttribute('cx',p.x);
				circle.setAttribute('cy',p.y);
			};
			svg.appendChild(circle);
			return positionableThing(setPosition, onMeeting);
		};
		var initialYellowPosition = {x:0,y:0};
		var yellowCircle = circleThing('#ff0');
		yellowCircle.setPosition(space.positionFromMazePosition(initialYellowPosition));

		var redCircle = circleThing('#f00',function(c){
			if(c == yellowCircle){
				console.log("succeed level "+l.number);
				succeed();
			}
		});
		var initialRedPosition = model.positions.first(function(p){return p.x == model.maxX - 2 && p.y == model.maxY - 1;});
		redCircle.setPosition(space.positionFromMazePosition(initialRedPosition));

		var initialGreenPosition = model.positions.first(function(p){return p.x == model.maxX - 1 && p.y == model.maxY - 1;});
		var greenCircle = circleThing('#0f0', function(c){
			if(c == yellowCircle){
				console.log("fail level "+l.number);
				fail();
			}
		});
		greenCircle.setPosition(space.positionFromMazePosition(initialGreenPosition));
		var walkers = [
			thingWalker.controllableThingWalker(model, redCircle.setPosition, initialRedPosition, 2, 10),
			thingWalker.autonomousThingWalker(model, greenCircle.setPosition,initialGreenPosition, 2,l.greenSpeed)
			];

		var teardown = function(){
			walkers.map(function(w){
				w.stop();
			});
			redCircle.remove();
			greenCircle.remove();
			yellowCircle.remove();
			try{
				console.log("removing svg");
				body.removeChild(svg);
			}catch(e){
				console.log("svg had already been removed");
			}
			
		};

		succeed = function(){
			if(!failed){
				teardown();
				onSucceed();
				succeeded = true;
			}
		};

		fail = function(){
			if(!succeeded){
				teardown();
				onFail();
				failed=true;
			}
		};

		body.appendChild(svg);
		
		var start = function(){
			walkers.map(function(w){
				w.start();
			});
		};
		
		if(l.message){
			showPopup(l.message, start);
		}else{
			start();
		}
	};

	var playLevel = function(l, onSucceed, onFail){
		console.log("beginning to play level "+l.number);
		space.setBoxSize(l.boxSize);
		var createProgress = progressBar().createProgressPart;
		var seq = structureHelpers.actionSequence();
		mazeMaker.make(seq, space.getMaxX(), space.getMaxY(), createProgress);
		svgMazeDrawer.draw(seq, createProgress, l.boxSize);
		seq.add(function(soFar, done, update){
			playLevelWithModel(soFar.svg, l, soFar.model, onSucceed, onFail);
			update(1);
			done();
		},createProgress(""));
		seq.execute();
	};

	var playAgain = function(){
		var l = levelProvider.getNext();
		playLevel(l,function(){
			showPopup("You win level "+l.number+"! Go again?",function(){
				playAgain();
			},function(){});
		},function(){
			showPopup("You lose! Go again?",function(){
				levelProvider.reset();
				playAgain();
			},function(){});
		});
	};

	playAgain();
	

})(window.innerWidth, window.innerHeight, document.body, window.mazeGame);
</script></html>