<html>
<head><style>
body{background-color:#000;overflow: hidden;}
span{
	float: left;
}
.progress-total{
	width:100%;
	height:5px;
	background-color: #333;
	position: absolute;
	left:0px;
	top:50%;
	-webkit-transform:translateY(-50%);
	transform:translateY(-50%);
	padding:0px;
}
.progress-container{
	width:100%;
	height:100%;
	position: absolute;
	left:0px;
	top:0px;
}
.progress-text{
	color:#fff;
	font-size: 15px;
	font-family: Verdana;
	position: absolute;
	left:50%;
	top:50%;
	transform:translate(-50%,-150%);
	-webkit-transform:translate(-50%,-150%);
}
.progress-part{
	height:100%;
	background-color: #fff;
	padding: 0px;
	position: relative;
	left:0px;
	top:0px;
}
.circle {
	width:30px;
	height: 20px;
	background-repeat: no-repeat;
}
.redcircle {
	background-image: url("data:image/svg+xml;utf8,<svg width=\"30\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"15\" cy=\"10\" r=\"10\" fill=\"#f00\"/></svg>");
}
.yellowcircle {
	background-image: url("data:image/svg+xml;utf8,<svg width=\"30\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"15\" cy=\"10\" r=\"10\" fill=\"#ff0\"/></svg>");
}
.greencircle {
	background-image: url("data:image/svg+xml;utf8,<svg width=\"30\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"15\" cy=\"10\" r=\"10\" fill=\"#0f0\"/></svg>");
}
.popup{
	background-color:#000;
	border: 1pt solid #fff;
	border-radius:3px;
	font-family:sans-serif;
	font-size:20px;
	color:#fff;
}
.popup-container{
	padding:20px;
	left:50%;
	transform:translateX(-50%);
	-webkit-transform:translateX(-50%);
	position: fixed;
	transition-property:top;
	transition-duration:0.3s;
	-webkit-transition-property:top;
	-webkit-transition-duration:0.3s;
	width:50%;
	height: 30%;
}
div{color:#fff;}
.popup-button{
	position: absolute;
	bottom:20px;
}
.left{left:20px;}
.right{right:20px;}
div{color:#fff;}
</style></head>
<body></body>
<script src="mazeMaker.js"></script>
<script src="../makeModule.js"></script>
<script src="../makeNode.js"></script>
<script src="../structureHelpers.js"></script>
<script src="levelProvider.js"></script>
<script src="svgMazeDrawer.js"></script>
<script src="thingWalker.js"></script>
<script src="easer.js"></script>
<script>
(function(w, h, body, mazeGame){
	Array.prototype.first = function(test){
		var res, found = false;
		for(var i=0;i<this.length;i++){
			if(test(res = this[i])){
				found = true;
				break;
			}
		}
		if(found){
			return res;
		}
		return null;
	};
	var boxSize, maxY, maxX;
	var setBoxSize = function(s){
		boxSize = s;
		maxY = Math.floor(h / boxSize);
		maxX = Math.floor(w / boxSize);
	};
	
	var mazeMaker = window.getMazeMaker(structureHelpers.timeoutWhile);
	var chooseRandom = function(arr){
		return arr[Math.floor(Math.random() * arr.length)];
	};

	var copySet = structureHelpers.copySet;

	var screenPosition = function(x,y){
		return {
			x:x,
			y:y,
			minus:function(p){
				return screenPosition(x - p.x, y - p.y);
			}
		};
	};

	var mazePositionToScreenPosition = function(p){
		return screenPosition(boxSize * (p.x + 1/2), boxSize * (p.y + 1/2));
	};

	var representsSmallDistance = function(dx, dy){
		return Math.abs(dx) + Math.abs(dy) < boxSize / 3;
	};
	
	var direction = mazeMaker.direction;
	var svgMazeDrawer = mazeGame.getSvgMazeDrawer(direction);
	var easer = mazeGame.getEaser(makeModule, screenPosition, representsSmallDistance);
	var thingWalker = mazeGame.getThingWalker(makeModule, easer, direction, mazePositionToScreenPosition, body, chooseRandom);

	var mazeStringifier = (function(){
		var stringPicture = function(w,h){
			var rows = Array.apply(null, new Array(h)).map(function(){
				return Array.apply(null, new Array(w)).map(function(){return " ";}).join("");
			});
			var put = function(x,y,str){
				rows[y] = rows[y].substr(0,x) + str + rows[y].substr(x+1);
			};
			var toString = function(){
				return rows.join("\n");
			};
			return {
				put:function(x,y,str){
					put(x,y,str);
					return this;
				},
				toString:toString
			};
		};
		var intersectionCharacters = {
			"0123" : "\u253c",
			"012" : "\u2534",
			"013" : "\u2524",
			"01" : "\u2518",
			"023" : "\u251c",
			"02" : "\u2514",
			"03" : "\u2502",
			"0" : "\u2502",
			"123" :"\u252c",
			"12" : "\u2500",
			"13" :"\u2510",
			"1": "\u2500",
			"23" :"\u250c",
			"2": "\u2500",
			"3" :"\u2502"
		};
		var stringify = function(m){
			var pic = stringPicture(2*m.maxX + 1, 2*m.maxY + 1);
			var borderDirections = Array.apply(null, new Array(m.maxX + 1)).map(function(){
				return Array.apply(null, new Array(m.maxY + 1)).map(function(){return [];});
			});
			m.borderParts.map(function(p){
				var x = 2*p.x + 1,y = 2*p.y + 1,str = p.direction == direction.LEFT || p.direction == direction.RIGHT ? "\u2502" : "\u2500";
				if(p.direction == direction.LEFT){
					x -= 1;
					borderDirections[p.x][p.y + 1].push(direction.TOP);
					borderDirections[p.x][p.y].push(direction.BOTTOM);
				}else if(p.direction == direction.RIGHT){
					x += 1;
					borderDirections[p.x + 1][p.y + 1].push(direction.TOP);
					borderDirections[p.x + 1][p.y].push(direction.BOTTOM);
				}else if(p.direction == direction.TOP){
					y -= 1;
					borderDirections[p.x + 1][p.y].push(direction.LEFT);
					borderDirections[p.x][p.y].push(direction.RIGHT);
				}else if(p.direction == direction.BOTTOM){
					y += 1;
					borderDirections[p.x + 1][p.y + 1].push(direction.LEFT);
					borderDirections[p.x][p.y + 1].push(direction.RIGHT);
				}
				pic.put(x,y,str);
			});
			borderDirections.map(function(c, x){
				c.map(function(b,y){
					if(b.length > 0){
						pic.put(2*x, 2*y, intersectionCharacters[b.sort(function(a,b){return a-b;}).map(function(a){return a.toString();}).join('')]);
					}
				});
			});

			return pic.toString();
		};
		return {stringify:stringify};
	})();

	var mazeDrawer = (function(){
		var draw = function(m, ctx, boxSize, drawPaths){
			if(drawPaths){
				var baseHue = Math.floor(Math.random() * 40);
				m.paths.map(function(p, i){
					ctx.fillStyle = 'hsl('+(baseHue + p[0].depth * 3)+',60%,'+Math.floor(10 + 70 / (1 + p[0].depth / 2))+'%)';
					p.map(function(pp){
						ctx.fillRect(pp.x * boxSize, pp.y * boxSize, boxSize, boxSize);
					});
				});
			}
			m.borderParts.map(function(p){
				var x1, y1, x2, y2;
				if(p.direction == direction.TOP){
					x1 = p.x; x2 = p.x + p.length; y1 = y2 = p.y;
				}else if(p.direction == direction.BOTTOM){
					x1 = p.x + 1 - p.length; x2 = p.x + 1; y1 = y2 = p.y + 1;
				}else if(p.direction == direction.LEFT){
					y1 = p.y + 1; y2 = p.y + 1 - p.length; x1 = x2 = p.x;
				}else if(p.direction == direction.RIGHT){
					y1 = p.y; y2 = p.y + p.length; x1 = x2 = p.x + 1;
				}
				ctx.strokeStyle = '#000';
				ctx.beginPath();
				ctx.moveTo(x1 * boxSize, y1 * boxSize);
				ctx.lineTo(x2 * boxSize, y2 * boxSize);
				ctx.stroke();
			});
		};
		return {draw:draw};
	})();

	


	var progressMaker = function(setup, done){
		done = done || function(){};
		setup = setup();
		var stopped = false;
		return {
			update:function(x){
				if(!stopped){
					setup.update(x);
				}
			},
			done:function(){setup.teardown();stopped = true;done();}
		};
	};

	var progressBar = function(){
		var started = false, currentPercentage = 0, done = false;
		var bar = makeNode("<div id='1' class='progress-container'><div class='progress-text' id='3'></div><div class='progress-total'><div id='2' class='progress-part'></div></div></div>",function(tot,part,text){
			return {
				append:function(){
					body.appendChild(tot);
				},
				remove:function(){
					body.removeChild(tot);
				},
				setPercentage:function(x){
					part.style.width = Math.floor(100 * x) + "%";
				},
				setText:function(t){
					text.innerHTML = t;
				}
			};
		});
		var updateGlobal = function(x){
			if(!started){
				bar.append();
			}
			started = true;
			currentPercentage = x;
			bar.setPercentage(x);
		};
		var createProgressPart = function(text){
			var textSet = false;
			return progressMaker(function(){
				return {
					update:function(x){
						if(!textSet){
							bar.setText(text);
							textSet = true;
						}
						updateGlobal(x.total);
					},
					teardown:function(){
						if(!done && currentPercentage > 0.99){
							bar.remove();
							done = true;
						}
					}
				};
			});
		};
		return {createProgressPart:createProgressPart};
	};

	var showPopup = function(html, confirm, reject){
		var div;
		disappear = function(){
			body.removeChild(div.node);
		};
		div = makeNode("<div id='2' class='popup popup-container' style='top:"+(2*h)+"px'><div>"+html+"</div><div id='1'></div></div>",function(buttonDiv, container){
			var ok, cancel;
			if(confirm){
				ok = makeNode("<input type='button' class='popup popup-button right' value='OK'/>");
				buttonDiv.appendChild(ok);
				ok.onclick = function(){
					disappear();
					confirm();
				};
			}
			if(reject){
				cancel = makeNode("<input type='button' class='popup popup-button left' value='Cancel'/>");
				buttonDiv.appendChild(cancel);
				cancel.onclick = function(){
					disappear();
					reject();
				};
			}
			return {
				node:container,
				focus:function(){
					ok.focus();
				},
				setTop:function(p){
					container.style.top = p;
				}
			};
		});
		body.appendChild(div.node);
		div.focus();
		setTimeout(function(){
			div.setTop((h/4)+"px");
		},1);
		
	};

	

	var positionableThing = (function(){
		var all = [], copies = copySet([], function(o){
			var c = {
				setPosition:o.setPosition
			};
			return c;
		});
		var areClose = function(p1,p2){
			return p1 && p2 && Math.abs(p1.x - p2.x) + Math.abs(p1.y - p2.y) < boxSize/2;
		};
		var check = function(){
			for(var i=0;i<all.length;i++){
				for(var j = i+1;j<all.length;j++){
					if(areClose(all[i].getPosition(), all[j].getPosition())){
						all[i].onMeeting(copies.copyOf(all[j]));
						all[j].onMeeting(copies.copyOf(all[i]));
					}else{
						all[i].onCeasingToMeet(copies.copyOf(all[j]));
						all[j].onCeasingToMeet(copies.copyOf(all[i]));
					}
				}
			}
		};
		var makeNew = function(_setPosition, _onMeeting){
			_onMeeting = _onMeeting || function(){};
			var alreadyMeeting = [];
			var onMeeting = function(other){
				if(alreadyMeeting.indexOf(other) == -1){
					_onMeeting(other);
					alreadyMeeting.push(other);
				}
			};
			var onCeasingToMeet = function(other){
				var index;
				if((index = alreadyMeeting.indexOf(other)) != -1){
					alreadyMeeting.splice(index,1);
				}
			};
			var currentPosition;
			var setPosition = function(p){
				currentPosition = p;
				_setPosition(p);
				check();
			};
			return {
				setPosition:setPosition,
				getPosition:function(){return currentPosition;},
				onMeeting:onMeeting,
				onCeasingToMeet:onCeasingToMeet
			};
		};
		return function(_setPosition, onMeeting){
			var n = makeNew(_setPosition, onMeeting);
			all.push(n);
			var c = copies.addFor(n);
			c.remove = function(){
				console.log("removing positionableThing");
				copies.removeFor(n);
				all.splice(all.indexOf(n),1);
			};
			return c;
		};
	})();
	
	var levelProvider = mazeGame.getLevelProvider();

	var playLevelWithModel = function(l, model, onSucceed, onFail){
		var succeed, fail, svg = svgMazeDrawer.draw(model, boxSize), succeeded = false, failed = false;
		var circleThing = function(color, onMeeting){
			var circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
			circle.setAttribute('r',boxSize * 0.2);
			circle.setAttribute('fill',color);
			var setPosition = function(p){
				circle.setAttribute('cx',p.x);
				circle.setAttribute('cy',p.y);
			};
			svg.appendChild(circle);
			return positionableThing(setPosition, onMeeting);
		};
		var initialYellowPosition = {x:0,y:0};
		var yellowCircle = circleThing('#ff0');
		yellowCircle.setPosition(mazePositionToScreenPosition(initialYellowPosition));

		var redCircle = circleThing('#f00',function(c){
			if(c == yellowCircle){
				console.log("succeed level "+l.number);
				succeed();
			}
		});
		var initialRedPosition = model.positions.first(function(p){return p.x == model.maxX - 2 && p.y == model.maxY - 1;});
		redCircle.setPosition(mazePositionToScreenPosition(initialRedPosition));

		var initialGreenPosition = model.positions.first(function(p){return p.x == model.maxX - 1 && p.y == model.maxY - 1;});
		var greenCircle = circleThing('#0f0', function(c){
			if(c == yellowCircle){
				console.log("fail level "+l.number);
				fail();
			}
		});
		greenCircle.setPosition(mazePositionToScreenPosition(initialGreenPosition));
		var walkers = [
			thingWalker.controllableThingWalker(model, redCircle.setPosition, initialRedPosition, 2, 10),
			thingWalker.autonomousThingWalker(model, greenCircle.setPosition,initialGreenPosition, 2,l.greenSpeed)
			];

		var teardown = function(){
			walkers.map(function(w){
				w.stop();
			});
			redCircle.remove();
			greenCircle.remove();
			yellowCircle.remove();
			try{
				console.log("removing svg");
				body.removeChild(svg);
			}catch(e){
				console.log("svg had already been removed");
			}
			
		};

		succeed = function(){
			if(!failed){
				teardown();
				onSucceed();
				succeeded = true;
			}
		};

		fail = function(){
			if(!succeeded){
				teardown();
				onFail();
				failed=true;
			}
		};

		body.appendChild(svg);
		
		var start = function(){
			walkers.map(function(w){
				w.start();
			});
		};
		
		if(l.message){
			showPopup(l.message, start);
		}else{
			start();
		}
	};

	var playLevel = function(l, onSucceed, onFail){
		console.log("beginning to play level "+l.number);
		setBoxSize(l.boxSize);
		var createProgress = progressBar().createProgressPart;
		var seq = structureHelpers.actionSequence();
		mazeMaker.make(seq, maxX, maxY, createProgress);
		seq.add(function(soFar, done, update){
			playLevelWithModel(l,soFar,onSucceed,onFail);
			update(1);
			done();
		}, createProgress(""));
		seq.execute();
	};

	var playAgain = function(){
		var l = levelProvider.getNext();
		playLevel(l,function(){
			showPopup("You win level "+l.number+"! Go again?",function(){
				playAgain();
			},function(){});
		},function(){
			showPopup("You lose! Go again?",function(){
				levelProvider.reset();
				playAgain();
			},function(){});
		});
	};

	playAgain();
	

})(document.body.offsetWidth, document.body.offsetHeight, document.body, window.mazeGame);
</script></html>