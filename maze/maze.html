<!DOCTYPE html>
<html>
<head><LINK href="maze.css" rel="stylesheet" type="text/css"></head>
<body></body>
<script src="mazeMaker.js"></script>
<script src="../makeModule.js"></script>
<script src="../makeNode.js"></script>
<script src="../structureHelpers.js"></script>
<script src="levelProvider.js"></script>
<script src="svgMazeDrawer.js"></script>
<script src="thingWalker.js"></script>
<script src="positionableThing.js"></script>
<script src="easer.js"></script>
<script src="../contourMaker.js"></script>
<script src="canvasMazeDrawer.js"></script>
<script src="mazeStringifier.js"></script>
<script src="progressBar.js"></script>
<script src="showPopup.js"></script>
<script src="joystick.js"></script>
<script>
(function(w, h, body, mazeGame){
	Array.prototype.first = function(test){
		var res, found = false;
		for(var i=0;i<this.length;i++){
			if(test(res = this[i])){
				found = true;
				break;
			}
		}
		if(found){
			return res;
		}
		return null;
	};
	var position = function(x,y){
		return {
			x:x,
			y:y,
			minus:function(p){
				return position(x - p.x, y - p.y);
			},
			plus:function(p){
				return position(x + p.x, y + p.y);
			},
			scale:function(r){
				return position(r*x, r*y);
			}
		};
	};
	var joystick;
	var mazeMaker = window.getMazeMaker(structureHelpers.timeoutWhile);
	var chooseRandom = function(arr){
		return arr[Math.floor(Math.random() * arr.length)];
	};

	var space = (function(){
		var shift = position(0,0);
		var boxSize, maxY, maxX, bottomPadding;
		var getInnerHeight = function(){return h - (bottomPadding || 0);};
		var setBoxSize = function(s){
			boxSize = w * s;
			maxY = Math.floor(getInnerHeight() / boxSize);
			maxX = Math.floor(w / boxSize);
		};
		var mazePositionToScreenPosition = function(p){
			if(p==null){
				console.log("oeps");
			}
			return position(boxSize * (p.x + 1/2), boxSize * (p.y + 1/2)).plus(shift);
		};

		var representsSmallDistance = function(dx, dy){
			return Math.abs(dx) + Math.abs(dy) < boxSize / 3;
		};
		var setBottomPadding = function(p){bottomPadding = p;};
		return {
			positionFromMazePosition:mazePositionToScreenPosition,
			representsSmallDistance:representsSmallDistance,
			getMaxX:function(){return maxX;},
			getMaxY:function(){return maxY;},
			setBoxSize:setBoxSize,
			getBoxSize:function(){return boxSize;},
			setShift:function(s){shift = s;},
			setBottomPadding:setBottomPadding,
			getInnerHeight:getInnerHeight
		};

	})();
	var weAreOnMobile = function(){
		return h > w;
	};

	if(weAreOnMobile()){
		space.setBottomPadding(200);
		joystick = mazeGame.getJoystickMaker(body, structureHelpers.sender, mazeMaker.direction, structureHelpers.throttle)(0,space.getInnerHeight(),200);
		body.appendChild(joystick.svg);
	}
	var positionableThing = mazeGame.getPositionableThing(space, structureHelpers.copySet);
	var direction = mazeMaker.direction;
	var svgMazeDrawer = mazeGame.getSvgMazeDrawer(direction, structureHelpers.timeoutWhile, contourMaker, position, space.setShift);
	var easer = mazeGame.getEaser(makeModule, position, space.representsSmallDistance);
	var thingWalker = mazeGame.getThingWalker(makeModule, easer, direction, space.positionFromMazePosition, body, chooseRandom);
	var mazeStringifier = mazeGame.getMazeStringifier(direction);
	var mazeDrawer = mazeGame.getCanvasMazeDrawer(direction);
	var levelProvider = mazeGame.getLevelProvider();
	var progressBar = mazeGame.getProgressBar(body);
	var showPopup = mazeGame.getShowPopup(body, h);

	

	

	var playLevelWithModel = function(svg, l, model, onSucceed, onFail, joystick){
		var succeed, fail, succeeded = false, failed = false;
		var circleThing = function(color, onMeeting){
			var circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
			circle.setAttribute('r',space.getBoxSize() * 0.25);
			circle.setAttribute('fill',color);
			var setPosition = function(p){
				circle.setAttribute('cx',p.x);
				circle.setAttribute('cy',p.y);
			};
			svg.appendChild(circle);
			return positionableThing(setPosition, onMeeting);
		};
		var initialYellowPosition = {x:0,y:0};
		var yellowCircle = circleThing('#ff0');
		yellowCircle.setPosition(space.positionFromMazePosition(initialYellowPosition));

		var redCircle = circleThing('#f00',function(c){
			if(c == yellowCircle){
				console.log("succeed level "+l.number);
				succeed();
			}
		});
		var initialRedPosition = model.positions.first(function(p){return p.x == model.maxX - 2 && p.y == model.maxY - 1;});
		redCircle.setPosition(space.positionFromMazePosition(initialRedPosition));

		var initialGreenPosition = model.positions.first(function(p){return p.x == model.maxX - 1 && p.y == model.maxY - 1;});
		var greenCircle = circleThing('#0f0', function(c){
			if(c == yellowCircle){
				console.log("fail level "+l.number);
				fail();
			}
		});
		greenCircle.setPosition(space.positionFromMazePosition(initialGreenPosition));
		var walkers = [
			thingWalker.controllableThingWalker(model, redCircle.setPosition, initialRedPosition, 2, 10, joystick),
			thingWalker.autonomousThingWalker(model, greenCircle.setPosition,initialGreenPosition, 2,l.greenSpeed)
			];

		var teardown = function(){
			walkers.map(function(w){
				w.stop();
			});
			redCircle.remove();
			greenCircle.remove();
			yellowCircle.remove();
			try{
				console.log("removing svg");
				body.removeChild(svg);
			}catch(e){
				console.log("svg had already been removed");
			}
			
		};

		succeed = function(){
			if(!failed){
				teardown();
				onSucceed();
				succeeded = true;
			}
		};

		fail = function(){
			if(!succeeded){
				teardown();
				onFail();
				failed=true;
			}
		};
		
		body.appendChild(svg);
		
		var start = function(){
			walkers.map(function(w){
				w.start();
			});
		};
		
		if(l.message){
			showPopup(l.message, start);
		}else{
			start();
		}
	};

	var playLevel = function(l, onSucceed, onFail, joystick){
		console.log("beginning to play level "+l.number);
		space.setBoxSize(l.boxSize);
		var createProgress = progressBar().createProgressPart;
		var seq = structureHelpers.actionSequence();
		mazeMaker.make(seq, space.getMaxX(), space.getMaxY(), createProgress);
		svgMazeDrawer.draw(seq, createProgress, space.getBoxSize(), false, w, space.getInnerHeight());
		seq.add(function(soFar, done, update){
			playLevelWithModel(soFar.svg, l, soFar.model, onSucceed, onFail, joystick);
			update(1);
			done();
		},createProgress(""));
		seq.execute();
	};

	var playAgain = function(){
		var l = levelProvider.getNext();
		playLevel(l,function(){
			showPopup("You win level "+l.number+"! Go again?",function(){
				playAgain();
			},function(){});
		},function(){
			showPopup("You lose! Go again?",function(){
				levelProvider.reset();
				playAgain();
			},function(){});
		}, joystick);
	};

	playAgain();
	

})(window.innerWidth, window.innerHeight, document.body, window.mazeGame);
</script></html>