<html>
<head>
<style>
div.parent {margin:10px;}
</style>
</head>
	<body>
		<div class="parent" style="height:200px" data-contour="parent a">
			<div>
				<span data-contour="child b" style="margin:-5px;padding:5px">Whatever</span>
			</div>
			<div class="parent" data-contour="parent b" style="height:100px;">
				<span data-contour="child a">Whatever else</span>
			</div>
			
		</div>
	</body>
	<script src="structureHelpers.js"></script>
	<script src="contourMaker.js"></script>
	<script>
	(function(str){
		var xPath = ".//*[contains(@data-contour,'parent' ) or contains(@data-contour,'child')]";
		var toArray = function(iterator){
			var next, result = [];
			while(next = iterator.iterateNext()){
				result.push(next);
			}
			return result;
		};
		var contourChildrenOf = function(node){
			return toArray( document.evaluate(xPath, node, null, XPathResult.ANY_TYPE, null) );
		};
		var concatenate = function(a,b){return a.concat(b);};

		var contourNameOf = function(node){
			return node.getAttribute('data-contour').match(/^(?:parent|child)\s(.*)$/)[1];
		};

		var draw = function(instructions){
			
			var parents = str.makeTrees(
				contourChildrenOf(document),
				function(n1, n2){
					return contourChildrenOf(n1).indexOf(n2) != -1;
				})
				.map(function(n){return str.allNodes(n);})
				.reduce(concatenate)
				.filter(function(n){return n.node.getAttribute('data-contour').indexOf("parent") != -1;});
			
			parents.map(function(p){
				var children;
				if(p.parent && (children = p.parent.children)){
					children.splice(children.indexOf(p),1);
					p.parent = null;
				}
			});
			var sets = parents.map(function(p){
				return {
					parent: p.node,
					children: p.children.map(function(c){return str.allNodes(c);}).reduce(concatenate).map(function(c){return c.node;})
				};
			});
			
			sets.map(function(set){
				var children, parentName = contourNameOf(set.parent);
				if(instructions[parentName]){
					children = {};
					set.children.map(function(child){
						children[contourNameOf(child)] = child;
					});
					instructions[parentName].apply(null, [set.parent, children]);
				}
			});
		
		};
		draw({
			"a": function(parent, children){
				console.log(parent);
				console.log(children);
			},
			"b": function(parent, children){
				console.log(parent);
				console.log(children);
			}
		});
	})(window.structureHelpers);
	</script>
</html>